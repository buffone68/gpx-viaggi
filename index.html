<script>
  const files = [
    '2025-07-28-Giorno-01-Namibia.GPX',
    '2025-07-29-Giorno-02-Namibia.GPX',
    '2025-07-30-Giorno-03-Namibia.GPX',
    '2025-07-31-Giorno-04-Namibia.GPX',
    '2025-08-01-Giorno-05-Namibia.GPX',
    '2025-08-02-Giorno-06-Namibia.GPX',
    '2025-08-03-Giorno-07-Namibia.GPX',
    '2025-08-04-Giorno-08-Namibia.GPX',
    '2025-08-05-Giorno-09-Namibia.GPX',
    '2025-08-06-Giorno-10-Namibia.GPX',
    '2025-08-07-Giorno-11-Namibia.GPX',
    '2025-08-08-Giorno-12-Namibia.GPX',
    '2025-08-09-Giorno-13-Namibia.GPX',
    '2025-08-10-Giorno-14-Namibia.GPX'
  ].map(f => `https://raw.githubusercontent.com/buffone68/gpx-viaggi/refs/heads/main/2025.07-Namibia/${f}`);

  const colors = ['#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#a65628','#f781bf','#999','#1b9e77','#d95f02','#7570b3','#e7298a','#66a61e','#e6ab02'];

  const map = L.map('map', { preferCanvas:true }).setView([-22.56, 17.08], 5);

  // Basemap: OSM + Carto light/dark
  const baseOSM   = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
  const baseLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap, © CARTO'});
  const baseDark  = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{attribution:'© OpenStreetMap, © CARTO'});
  L.control.layers({OSM:baseOSM,'Carto Light':baseLight,'Carto Dark':baseDark},{},{collapsed:true}).addTo(map);

  const overall = L.latLngBounds([]);
  const legend  = document.getElementById('legend');
  const layers  = [];   // { layer, name, color, checkbox }
  let remaining = files.length, totalKm = 0;

  // Legenda in ordine fisso con checkbox
  files.forEach((url, i) => {
    const color = colors[i % colors.length];
    const name  = url.split('/').pop().replace('.GPX','');

    const row   = document.createElement('div');
    const cb    = document.createElement('input');
    cb.type = 'checkbox'; cb.checked = true; cb.style.marginRight = '6px';
    const sw    = document.createElement('span');
    sw.className = 'swatch'; sw.style.background = color;
    const label = document.createElement('span'); label.textContent = name;

    row.appendChild(cb); row.appendChild(sw); row.appendChild(label);
    legend.appendChild(row);

    const gpx = new L.GPX(url, {
      async: true,
      polyline_options: { color, weight: 4, opacity: 0.95 },
      marker_options: { startIconUrl:null, endIconUrl:null, shadowUrl:null }
    })
    .on('loaded', e => {
      overall.extend(e.target.getBounds());
      // distanza (km) se disponibile
      const km = (e.target.get_distance ? e.target.get_distance()/1000 : 0);
      if (km) { 
        totalKm += km; 
        label.textContent = `${name} (${km.toFixed(1)} km)`;
      }
      if (--remaining === 0) {
        const tot = document.createElement('div');
        tot.style.marginTop = '8px';
        tot.innerHTML = `<b>Totale</b>: ${totalKm.toFixed(1)} km`;
        legend.appendChild(tot);
        map.fitBounds(overall,{padding:[20,20]});
      }
    })
    // highlight on hover
    .on('mouseover', e => { e.target.setStyle({weight:6}); e.target.bringToFront(); })
    .on('mouseout',  e => { e.target.setStyle({weight:4}); });

    gpx.addTo(map);

    // toggle layer
    cb.addEventListener('change', () => {
      if (cb.checked) { gpx.addTo(map); } else { map.removeLayer(gpx); }
    });

    layers.push({layer:gpx, name, color, checkbox:cb});
  });

  // Bottone Fit All
  L.control.zoom({ position:'topleft' }).addTo(map);
  const FitAll = L.Control.extend({
    onAdd: function() {
      const btn = L.DomUtil.create('button');
      btn.textContent = 'Fit';
      btn.title = 'Riquadra tutti';
      btn.style.cssText = 'position:absolute;top:100px;left:10px;z-index:9999;padding:6px 8px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer';
      btn.onclick = () => map.fitBounds(overall,{padding:[20,20]});
      return btn;
    }
  });
  new FitAll({position:'topleft'}).addTo(map);

  // Parametro ?day=06 per zoom su un singolo giorno
  const p = new URLSearchParams(location.search).get('day');
  if (p) {
    const wanted = files.findIndex(u => u.includes(`Giorno-${p}-`));
    if (wanted >= 0) {
      layers.forEach((Lr, idx) => { 
        if (idx !== wanted) { Lr.checkbox.checked = false; map.removeLayer(Lr.layer); }
      });
      layers[wanted].layer.once('loaded', e => map.fitBounds(e.target.getBounds(),{padding:[20,20]}));
    }
  }
</script>
